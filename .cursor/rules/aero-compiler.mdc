---
description: Aero compiler, runtime, and Vite plugin conventions
globs: packages/core/**/*.ts
alwaysApply: false
---

# Aero Compiler & Runtime

All of the following live in **packages/core** (the framework package).

## Modules

- **compiler/parser.ts** - Extract script blocks from HTML; use constants from **compiler/constants.ts** (ATTR_IS_BUILD, ATTR_IS_INLINE, COMPONENT_SUFFIX_REGEX, EACH_REGEX, etc.)
- **compiler/build-script-analysis.ts** - AST-based analysis of build script content (oxc-parser): extracts imports and `export function getStaticPaths`; used by codegen.
- **compiler/tokenizer.ts** - Re-exports from `@aerobuilt/interpolation`; use for text/attribute compilation.
- **packages/interpolation** - Shared package `@aerobuilt/interpolation`: `{ }` tokenizer (brace depth, strings, comments). Used by core and can be used by aero-vscode.
- **compiler/codegen.ts** - Emit async render functions; uses build-script-analysis for build script imports and getStaticPaths; handle `{ }` interpolation via helpers, `data-each`, `data-if` / `data-else-if` / `data-else`
- **compiler/resolver.ts** - Resolve component/layout paths against path aliases (from project tsconfig)
- **compiler/helpers.ts** - Interpolation (compileInterpolation, compileAttributeInterpolation use tokenizer), attribute helpers
- **vite/index.ts** - Vite plugin: virtual modules for client scripts; use `\0` prefix for Vite virtual module IDs (not `/@aero/client/` in emitted IDs)
- **vite/build.ts** - Build orchestration, page discovery, Nitro integration
- **runtime/** - `Aero` class, instance context, client entry (client.ts, index.ts, instance.ts)
- **utils/aliases.ts** - Load tsconfig path aliases; **utils/routing.ts** - routing helpers

## Constants (packages/core/compiler/constants.ts)

Use named constants: `ATTR_PROPS`, `ATTR_EACH`, `ATTR_IF`, `ATTR_ELSE_IF`, `ATTR_ELSE`, `ATTR_IS_BUILD`, `ATTR_IS_INLINE`, `ATTR_PASS_DATA`, `TAG_SLOT`, `SLOT_NAME_DEFAULT`, `COMPONENT_SUFFIX_REGEX`, `EACH_REGEX`, `ALPINE_ATTR_REGEX`, `VOID_TAGS`. For `{ }` interpolation use **compiler/tokenizer.ts** (not `CURLY_INTERPOLATION_REGEX`, which is deprecated). Script taxonomy: `is:build`, `is:inline`, `is:blocking`, plain `<script>` (client); see docs/script-taxonomy.md.

## TDD (red-to-green)

When implementing new features or tracking down bugs, use TDD: (1) write or run a failing test that captures the behavior or reproduces the bug (red); (2) implement the minimal change to make the test pass (green); (3) refactor if needed. For bugs, always add or adjust a failing test first; do not skip to the fix.

## Tests

- Vitest in **packages/core**: `compiler/__tests__/` (parser.test.ts, codegen.test.ts, build-script-analysis.test.ts, vite-plugin.test.ts), `vite/__tests__/` (build.test.ts)
- Run from repo root: `pnpm test` or from packages/core: `pnpm test`

## Gotchas

- Virtual client script IDs should use `\0` prefix for proper Vite handling
- Slot passthrough: both `name` and `slot` on `<slot>` elements
