---
description: Aero framework architecture and conventions
alwaysApply: true
---

# Aero Framework - Architecture

Aero is a static site generator with an HTML-first template engine.

## Monorepo Layout

- **Root** - Workspace root. Scripts delegate to packages/core and packages/templates/kitchen-sink.
- **packages/core** - Framework: compiler, runtime, Vite plugin. Built with tsup; consumed as `@aero-ssg/core` and `@aero-ssg/vite`.
- **packages/vite** - Vite plugin re-export (@aero-ssg/vite).
- **packages/vscode** - VS Code extension (syntaxes, etc.).
- **packages/start** - Project initializer (create-aerobuilt). Scaffolds into packages/start/dist/<name> from templates (dist is gitignored).
- **packages/templates/kitchen-sink** - Full demo app (client/, server/, vite.config, nitro.config). Root `dev`/`build`/`preview` run this.
- **packages/templates/minimal** - Minimal template (client/, content/, no server).

Build order: `predev` / `prebuild` run `pnpm --dir packages/core build` so the app uses the built framework.

## Pipeline (packages/core)

1. **Parser** (packages/core/compiler/parser.ts) - Extracts `<script is:build>`, client (plain `<script>`), `<script is:inline>`, and `<script is:blocking>` from HTML
2. **Build-script analysis** (packages/core/compiler/build-script-analysis.ts) - Parses build script with oxc-parser; extracts imports and `getStaticPaths` for codegen
3. **Codegen** (packages/core/compiler/codegen.ts) - Compiles templates into async render functions with `{ }` interpolation
4. **Vite Plugin** (packages/core/vite/index.ts) - Build orchestration, middleware, virtual modules for client scripts
5. **Runtime** (packages/core/runtime/index.ts) - `Aero` class renders pages and components with context

## App File Structure (templates: kitchen-sink, minimal)

- `client/pages/` - Route pages (index.html → `/`, about.html → `/about`)
- `client/components/` - Reusable components
- `client/layouts/` - Layout wrappers with `<slot>` support
- `content/` - Global data (e.g. site.ts exposed as `site` in templates)
- `client/assets/` - Styles, scripts, images
- `server/api/` - Nitro API handlers (e.g. submit.post.ts; kitchen-sink only)
- `server/routes/` - Nitro routes (e.g. catch-all for static files)

## TDD (red-to-green)

When implementing new features or tracking down bugs, use TDD: (1) write or run a failing test that captures the behavior or reproduces the bug (red); (2) implement the minimal change to make the test pass (green); (3) refactor if needed. For bugs, always add or adjust a failing test first; do not skip to the fix.

## Commands

- `pnpm run dev` - Vite dev server with HMR (Nitro enabled when `aero({ server: true })`; optional `site: 'https://...'` for canonical URL)
- `pnpm run build` - Static build to dist/; with Nitro also produces .output/
- `pnpm run preview` - Static preview (no API)
- `pnpm run preview:api` - Full server preview (static + API)
- `pnpm test` / `npx vitest` - Tests (run from root; Vitest in packages/core)

## Path Aliases (templates: tsconfig in kitchen-sink, minimal)

- `@components/*` → client/components/\*
- `@layouts/*` → client/layouts/\*
- `@pages/*` → client/pages/\*
- `@content/*` → content/\*
- `@styles/*` → client/assets/styles/\*
- `@scripts/*` → client/assets/scripts/\*
- `@images/*` → client/assets/images/\*
- `@src/*` → client/\*
- `@server/*` → server/\*
- `~/*` → project root
