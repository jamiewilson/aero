# TBD

## Static build and dev

- Install deps: `pnpm install`.
- Develop with a single origin (pages + API): `pnpm dev`.
- Develop static pages only (no Nitro): `pnpm dev:static`.
- Build the static site: `pnpm build`.
- The build emits root-style pages in `dist/` (examples: `dist/index.html`, `dist/about/index.html`, `dist/docs/index.html`) plus bundled assets in `dist/assets/`.
- Generated links/assets are relative so pages can be opened directly with `file://` as a static bundle.
- Preview the built output with a local static server: `pnpm preview`.

## Unified API + site preview (single command)

- API handlers live in [server/api](server/api) (example: [server/api/submit.post.ts](server/api/submit.post.ts)).
- Build + preview with a single origin (static files + `/api/*`): `pnpm preview:full`.
- The catch-all route [server/routes/[...].ts](server/routes/[...].ts) serves `dist/` from the Nitro server so pages and API endpoints run from the same origin.
- API-only preview: `pnpm preview:api`.

## Production deployment modes

- Unified deploy (recommended default): run `pnpm run build:full` and deploy the Nitro server build.
- Static-only deploy (no API runtime): deploy only `dist/` generated by `pnpm run build`.
- API calls such as `/api/*` require a server runtime. Static-only deployments should avoid API-dependent interactions.

## Build outputs and static file flow

Running `pnpm build:full` (`vite build` then `nitro build`) produces **two independent outputs**, each designed for a different deployment mode. The `public/` directory is the single source of truth for static assets like favicons, `robots.txt`, and `og-image.png`.

### Where `public/` files end up

| Source     | Output location   | Why                                                                                                                                                                            |
| ---------- | ----------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `public/*` | `dist/`           | Vite copies public assets into the static build root. This is the complete static site.                                                                                        |
| `public/*` | `.output/public/` | Nitro copies public assets here for CDN/edge deployments (Cloudflare, Vercel, Netlify) where a CDN serves static files separately from the server.                             |
| `public/*` | `.output/server/` | Nitro embeds them so the server is self-contained — it can serve static files itself on platforms without a separate static layer (e.g. a standalone Node.js process, Docker). |

### Output directories

```
dist/                          ← vite build (static-only deployment target)
├── index.html
├── about/index.html
├── assets/scripts/            ← hashed JS bundles
├── assets/styles/             ← hashed CSS bundles
├── favicon.svg, robots.txt    ← from public/
└── .vite/manifest.json

.output/                       ← nitro build (server deployment target)
├── public/                    ← static assets for CDN layer
│   ├── assets/scripts/
│   ├── assets/styles/
│   ├── favicon.svg, robots.txt
│   └── .vite/manifest.json
└── server/                    ← self-contained server
    ├── index.mjs              ← entry point
    ├── chunks/routes/         ← API handlers
    ├── chunks/nitro/          ← Nitro runtime
    ├── favicon.svg, robots.txt  ← embedded for standalone serving
    └── .vite/manifest.json
```

### Which output to deploy

| Mode                  | Command             | Deploy            | Serves static files via                                  | API  |
| --------------------- | ------------------- | ----------------- | -------------------------------------------------------- | ---- |
| **Static only**       | `pnpm build`        | `dist/`           | CDN, S3, GitHub Pages, or `file://`                      | None |
| **Server + CDN**      | `pnpm build:full`   | `.output/`        | CDN serves `.output/public/`, server handles `/api/*`    | Yes  |
| **Server standalone** | `pnpm build:full`   | `.output/server/` | Server serves everything (static + API) from one process | Yes  |
| **Preview (local)**   | `pnpm preview:full` | —                 | Nitro catch-all route serves from `dist/`                | Yes  |

### Why the duplication is intentional

The apparent triplication exists because each copy serves a different deployment architecture. You never deploy all three — you pick one mode:

- **Static-only** → use `dist/`, ignore `.output/`
- **CDN + serverless** → use `.output/public/` (CDN) + `.output/server/` (functions), ignore `dist/`
- **Standalone server** → use `.output/server/` only, ignore everything else

The `dist/` output also doubles as the local preview source — the Nitro catch-all route in [server/routes/[...].ts](server/routes/[...].ts) reads from `dist/` at runtime during `pnpm preview:full`.

## TBD plugin options

`tbd()` supports a small set of user-facing options in `vite.config.ts`:

- `nitro` (boolean): enable Nitro integration in Vite (default: false; set `nitro: true` explicitly to enable).
- `apiPrefix` (string): URL prefix treated as API routes (default: `/api`). Used to: (a) bypass TBD HTML handling in dev so Nitro serves those paths; (b) skip relative-URL rewriting in static builds so `/api/*` links remain absolute for server use; (c) drive the Nitro catch-all (via `TBD_API_PREFIX` env) so requests under this prefix are not served as static files.
- `dirs`:
  - `src` (default `client`) — pages are always at `<src>/pages`, not configurable
  - `data` (default `data`)
  - `server` (default `server`) — must match `nitro.config.ts` `scanDirs` when using Nitro
  - `dist` (default `dist`, mapped to Vite `build.outDir`)

Example (default layout):

```ts
import { tbd } from './tbd/vite'
import { defineConfig } from 'vite'

export default defineConfig({
	plugins: tbd({ nitro: true }),
})
```

Custom structure override example:

```ts
import { tbd } from './tbd/vite'
import { defineConfig } from 'vite'

export default defineConfig({
	plugins: tbd({
		nitro: true,
		dirs: {
			src: 'web',
			data: 'content',
			server: 'api',
			dist: 'build',
		},
		apiPrefix: '/backend',
	}),
})
```

When using `preview:full` with non-default `dist` or `apiPrefix`, set env vars so the Nitro catch-all matches your overrides: `TBD_DIST`, `TBD_API_PREFIX`.

### `dirs.server` and `nitro.config.ts`

`dirs.server` is passed to the Nitro Vite plugin as `serverDir`, telling it where your API/routes live. `nitro.config.ts` has its own `scanDirs`, which tells Nitro which directories to scan for handlers. These must point to the same place: if you set `dirs.server: 'api'`, also set `scanDirs: ['api']` in `nitro.config.ts`. TBD does not auto-sync them.
